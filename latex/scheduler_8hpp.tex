\doxysection{include/scheduler.hpp File Reference}
\hypertarget{scheduler_8hpp}{}\label{scheduler_8hpp}\index{include/scheduler.hpp@{include/scheduler.hpp}}


Utilities for scheduling tasks and saving persistent data.  


{\ttfamily \#include $<$Nim\+BLEDevice.\+h$>$}\newline
{\ttfamily \#include $<$Adafruit\+\_\+\+MAX1704\+X.\+h$>$}\newline
{\ttfamily \#include $<$OWMAdafruit\+\_\+\+ADS1015.\+h$>$}\newline
{\ttfamily \#include $<$ble\+\_\+util.\+hpp$>$}\newline
{\ttfamily \#include $<$VWCSensor.\+hpp$>$}\newline
{\ttfamily \#include $<$Teros10.\+hpp$>$}\newline
{\ttfamily \#include $<$Atlas\+\_\+\+EZO-\/p\+H.\+hpp$>$}\newline
{\ttfamily \#include $<$Atlas\+\_\+\+Gravity\+\_\+p\+H.\+hpp$>$}\newline
Include dependency graph for scheduler.\+hpp\+:\nopagebreak
\begin{figure}[H]
\begin{center}
\leavevmode
\includegraphics[width=350pt]{scheduler_8hpp__incl}
\end{center}
\end{figure}
This graph shows which files directly or indirectly include this file\+:\nopagebreak
\begin{figure}[H]
\begin{center}
\leavevmode
\includegraphics[width=248pt]{scheduler_8hpp__dep__incl}
\end{center}
\end{figure}
\doxysubsubsection*{Classes}
\begin{DoxyCompactItemize}
\item 
struct \mbox{\hyperlink{structplanner}{planner}}
\begin{DoxyCompactList}\small\item\em Data structure for task scheduling stored in NVS. \end{DoxyCompactList}\end{DoxyCompactItemize}
\doxysubsubsection*{Functions}
\begin{DoxyCompactItemize}
\item 
\Hypertarget{scheduler_8hpp_aa2c353c6e3271404cdf45ce4601951c7}\label{scheduler_8hpp_aa2c353c6e3271404cdf45ce4601951c7} 
\mbox{\hyperlink{src_2main_8cpp_a2df27a00b191de3537c3b53adcecf1e8}{void}} {\bfseries init\+\_\+nvs} ()
\begin{DoxyCompactList}\small\item\em Open NVS, check if it is initialized with data, if not, initialize it. \end{DoxyCompactList}\item 
\mbox{\hyperlink{src_2main_8cpp_a2df27a00b191de3537c3b53adcecf1e8}{bool}} \mbox{\hyperlink{scheduler_8hpp_acde0b5aea233a35b69ff211f55208c6b}{task\+\_\+is\+\_\+scheduled}} (\mbox{\hyperlink{src_2main_8cpp_a2df27a00b191de3537c3b53adcecf1e8}{int}} \mbox{\hyperlink{src_2main_8cpp_a2df27a00b191de3537c3b53adcecf1e8}{reset\+\_\+count}})
\begin{DoxyCompactList}\small\item\em Check if a task will run this time, NVS must be initialized first! \end{DoxyCompactList}\item 
\Hypertarget{scheduler_8hpp_a2ce5745ffb225d3a8167ba1970e3b777}\label{scheduler_8hpp_a2ce5745ffb225d3a8167ba1970e3b777} 
\mbox{\hyperlink{src_2main_8cpp_a2df27a00b191de3537c3b53adcecf1e8}{void}} {\bfseries Read\+HT} ()
\begin{DoxyCompactList}\small\item\em Reads temperature and humidity sensors via BLE and then sends complete data to the database. \end{DoxyCompactList}\item 
\Hypertarget{scheduler_8hpp_ae6b4c9f02d24e6345a8244b129cb4bce}\label{scheduler_8hpp_ae6b4c9f02d24e6345a8244b129cb4bce} 
\mbox{\hyperlink{src_2main_8cpp_a2df27a00b191de3537c3b53adcecf1e8}{void}} {\bfseries Read\+Wired} ()
\begin{DoxyCompactList}\small\item\em Reads all wired sensors attached to the aggregator. \end{DoxyCompactList}\item 
\Hypertarget{scheduler_8hpp_a2137cbb31cc2a84abc73c9420ea062f1}\label{scheduler_8hpp_a2137cbb31cc2a84abc73c9420ea062f1} 
\mbox{\hyperlink{src_2main_8cpp_a2df27a00b191de3537c3b53adcecf1e8}{void}} {\bfseries OTAUpdate} ()
\begin{DoxyCompactList}\small\item\em Checks and updates from new code published at HTTPS address. \end{DoxyCompactList}\item 
\Hypertarget{scheduler_8hpp_a463da0b6a8745959b8d837ae6ee2c6f5}\label{scheduler_8hpp_a463da0b6a8745959b8d837ae6ee2c6f5} 
\mbox{\hyperlink{src_2main_8cpp_a2df27a00b191de3537c3b53adcecf1e8}{void}} {\bfseries Pat\+WDT} ()
\begin{DoxyCompactList}\small\item\em Pat the watchdog by raising watchdog done pin high, and then setting it low. \end{DoxyCompactList}\item 
\Hypertarget{scheduler_8hpp_af6136b721c9ebd2c70157f07e7061f96}\label{scheduler_8hpp_af6136b721c9ebd2c70157f07e7061f96} 
\mbox{\hyperlink{src_2main_8cpp_a2df27a00b191de3537c3b53adcecf1e8}{void}} {\bfseries Send\+TLM} ()
\begin{DoxyCompactList}\small\item\em Send a telemetry message to the MQTT broker. \end{DoxyCompactList}\item 
\mbox{\hyperlink{src_2main_8cpp_a2df27a00b191de3537c3b53adcecf1e8}{void}} \mbox{\hyperlink{scheduler_8hpp_a40655c198dfde88ff025be197f8bc0ea}{Scheduler}} (\mbox{\hyperlink{src_2main_8cpp_a2df27a00b191de3537c3b53adcecf1e8}{int}} \mbox{\hyperlink{src_2main_8cpp_a2df27a00b191de3537c3b53adcecf1e8}{reset\+\_\+count}})
\begin{DoxyCompactList}\small\item\em Perform a state transition based on the number of reset counts. \end{DoxyCompactList}\item 
\mbox{\hyperlink{src_2main_8cpp_a2df27a00b191de3537c3b53adcecf1e8}{void}} \mbox{\hyperlink{scheduler_8hpp_af44cadcb682d8c434f4c30a70cd62aa9}{Scheduler\+Clear\+All}} (\mbox{\hyperlink{src_2main_8cpp_a2df27a00b191de3537c3b53adcecf1e8}{int}} \mbox{\hyperlink{src_2main_8cpp_a2df27a00b191de3537c3b53adcecf1e8}{reset\+\_\+count}})
\begin{DoxyCompactList}\small\item\em Clear all tasks so that none are scheduled to run. \end{DoxyCompactList}\end{DoxyCompactItemize}
\doxysubsubsection*{Variables}
\begin{DoxyCompactItemize}
\item 
\mbox{\hyperlink{src_2main_8cpp_a2df27a00b191de3537c3b53adcecf1e8}{bool}} \mbox{\hyperlink{scheduler_8hpp_ac334200b5e3db6f6228d37cec3b03538}{maxlipo\+\_\+attached}}
\begin{DoxyCompactList}\small\item\em Fuel Gauge successfully initialized? \end{DoxyCompactList}\item 
\mbox{\hyperlink{src_2main_8cpp_a2df27a00b191de3537c3b53adcecf1e8}{Adafruit\+\_\+\+MAX17048}} \mbox{\hyperlink{scheduler_8hpp_a106fc9194d62779ffe942b866046530d}{maxlipo}}
\begin{DoxyCompactList}\small\item\em MAX17048 battery Fuel Gauge. \end{DoxyCompactList}\item 
\mbox{\hyperlink{classAdafruit__ADS1115}{Adafruit\+\_\+\+ADS1115}} \mbox{\hyperlink{scheduler_8hpp_a951ac31de71c2bf701a13e5f233fc6d8}{ads}}
\begin{DoxyCompactList}\small\item\em Analog to digital converter object (I2C) \end{DoxyCompactList}\item 
int \mbox{\hyperlink{scheduler_8hpp_a2df27a00b191de3537c3b53adcecf1e8}{reset\+\_\+count}} = -\/1
\begin{DoxyCompactList}\small\item\em number of resets retrieved for NVS \end{DoxyCompactList}\item 
\Hypertarget{scheduler_8hpp_a80a163e9b74768b4433d5bd250afd860}\label{scheduler_8hpp_a80a163e9b74768b4433d5bd250afd860} 
\mbox{\hyperlink{src_2main_8cpp_a2df27a00b191de3537c3b53adcecf1e8}{struct}} \mbox{\hyperlink{structplanner}{planner}} {\bfseries planner}
\end{DoxyCompactItemize}


\doxysubsection{Detailed Description}
Utilities for scheduling tasks and saving persistent data. 

Defines the mechanism for implementing task scheduling for sensors, OTA updates, etc. Timing is measured in "{}ticks"{}. One tick is approximately 64 seconds or the time that the watchdog timer waits before reseting the device and waking it from hibernation. Ticks are tracked between power cycles using the non-\/volatile storage (NVS) system.

\begin{DoxyAuthor}{Author}
Garrett Wells 
\end{DoxyAuthor}
\begin{DoxyDate}{Date}
2023 
\end{DoxyDate}


\doxysubsection{Function Documentation}
\Hypertarget{scheduler_8hpp_a40655c198dfde88ff025be197f8bc0ea}\label{scheduler_8hpp_a40655c198dfde88ff025be197f8bc0ea} 
\index{scheduler.hpp@{scheduler.hpp}!Scheduler@{Scheduler}}
\index{Scheduler@{Scheduler}!scheduler.hpp@{scheduler.hpp}}
\doxysubsubsection{\texorpdfstring{Scheduler()}{Scheduler()}}
{\footnotesize\ttfamily \mbox{\hyperlink{src_2main_8cpp_a2df27a00b191de3537c3b53adcecf1e8}{void}} Scheduler (\begin{DoxyParamCaption}\item[{\mbox{\hyperlink{src_2main_8cpp_a2df27a00b191de3537c3b53adcecf1e8}{int}}}]{reset\+\_\+count }\end{DoxyParamCaption})}



Perform a state transition based on the number of reset counts. 


\begin{DoxyParams}[1]{Parameters}
\mbox{\texttt{ in}}  & {\em reset\+\_\+count} & The number of resets that have been performed in this epoch \\
\hline
\end{DoxyParams}
\Hypertarget{scheduler_8hpp_af44cadcb682d8c434f4c30a70cd62aa9}\label{scheduler_8hpp_af44cadcb682d8c434f4c30a70cd62aa9} 
\index{scheduler.hpp@{scheduler.hpp}!SchedulerClearAll@{SchedulerClearAll}}
\index{SchedulerClearAll@{SchedulerClearAll}!scheduler.hpp@{scheduler.hpp}}
\doxysubsubsection{\texorpdfstring{SchedulerClearAll()}{SchedulerClearAll()}}
{\footnotesize\ttfamily \mbox{\hyperlink{src_2main_8cpp_a2df27a00b191de3537c3b53adcecf1e8}{void}} Scheduler\+Clear\+All (\begin{DoxyParamCaption}\item[{\mbox{\hyperlink{src_2main_8cpp_a2df27a00b191de3537c3b53adcecf1e8}{int}}}]{reset\+\_\+count }\end{DoxyParamCaption})}



Clear all tasks so that none are scheduled to run. 


\begin{DoxyParams}[1]{Parameters}
\mbox{\texttt{ in}}  & {\em reset\+\_\+count} & The number of reset counts to have elapsed. \\
\hline
\end{DoxyParams}
\Hypertarget{scheduler_8hpp_acde0b5aea233a35b69ff211f55208c6b}\label{scheduler_8hpp_acde0b5aea233a35b69ff211f55208c6b} 
\index{scheduler.hpp@{scheduler.hpp}!task\_is\_scheduled@{task\_is\_scheduled}}
\index{task\_is\_scheduled@{task\_is\_scheduled}!scheduler.hpp@{scheduler.hpp}}
\doxysubsubsection{\texorpdfstring{task\_is\_scheduled()}{task\_is\_scheduled()}}
{\footnotesize\ttfamily \mbox{\hyperlink{src_2main_8cpp_a2df27a00b191de3537c3b53adcecf1e8}{bool}} task\+\_\+is\+\_\+scheduled (\begin{DoxyParamCaption}\item[{\mbox{\hyperlink{src_2main_8cpp_a2df27a00b191de3537c3b53adcecf1e8}{int}}}]{reset\+\_\+count }\end{DoxyParamCaption})}



Check if a task will run this time, NVS must be initialized first! 


\begin{DoxyParams}[1]{Parameters}
\mbox{\texttt{ in}}  & {\em reset\+\_\+count} & The number of resets recorded.\\
\hline
\end{DoxyParams}
\begin{DoxyReturn}{Returns}
{\ttfamily true} if a task is scheduled to run this reboot cycle, {\ttfamily false} otherwise 
\end{DoxyReturn}


\doxysubsection{Variable Documentation}
\Hypertarget{scheduler_8hpp_a951ac31de71c2bf701a13e5f233fc6d8}\label{scheduler_8hpp_a951ac31de71c2bf701a13e5f233fc6d8} 
\index{scheduler.hpp@{scheduler.hpp}!ads@{ads}}
\index{ads@{ads}!scheduler.hpp@{scheduler.hpp}}
\doxysubsubsection{\texorpdfstring{ads}{ads}}
{\footnotesize\ttfamily \mbox{\hyperlink{classAdafruit__ADS1115}{Adafruit\+\_\+\+ADS1115}} ads\hspace{0.3cm}{\ttfamily [extern]}}



Analog to digital converter object (I2C) 

Interface for the analog to digital converter. ~\newline
 \Hypertarget{scheduler_8hpp_a106fc9194d62779ffe942b866046530d}\label{scheduler_8hpp_a106fc9194d62779ffe942b866046530d} 
\index{scheduler.hpp@{scheduler.hpp}!maxlipo@{maxlipo}}
\index{maxlipo@{maxlipo}!scheduler.hpp@{scheduler.hpp}}
\doxysubsubsection{\texorpdfstring{maxlipo}{maxlipo}}
{\footnotesize\ttfamily \mbox{\hyperlink{src_2main_8cpp_a2df27a00b191de3537c3b53adcecf1e8}{Adafruit\+\_\+\+MAX17048}} maxlipo\hspace{0.3cm}{\ttfamily [extern]}}



MAX17048 battery Fuel Gauge. 

Interface for the battery fuel gauge. \Hypertarget{scheduler_8hpp_ac334200b5e3db6f6228d37cec3b03538}\label{scheduler_8hpp_ac334200b5e3db6f6228d37cec3b03538} 
\index{scheduler.hpp@{scheduler.hpp}!maxlipo\_attached@{maxlipo\_attached}}
\index{maxlipo\_attached@{maxlipo\_attached}!scheduler.hpp@{scheduler.hpp}}
\doxysubsubsection{\texorpdfstring{maxlipo\_attached}{maxlipo\_attached}}
{\footnotesize\ttfamily \mbox{\hyperlink{src_2main_8cpp_a2df27a00b191de3537c3b53adcecf1e8}{bool}} maxlipo\+\_\+attached\hspace{0.3cm}{\ttfamily [extern]}}



Fuel Gauge successfully initialized? 

External flag indicating whether maxlipo was initialized successfully. \Hypertarget{scheduler_8hpp_a2df27a00b191de3537c3b53adcecf1e8}\label{scheduler_8hpp_a2df27a00b191de3537c3b53adcecf1e8} 
\index{scheduler.hpp@{scheduler.hpp}!reset\_count@{reset\_count}}
\index{reset\_count@{reset\_count}!scheduler.hpp@{scheduler.hpp}}
\doxysubsubsection{\texorpdfstring{reset\_count}{reset\_count}}
{\footnotesize\ttfamily int reset\+\_\+count = -\/1}



number of resets retrieved for NVS 

External variable holding the number of resets recorded by the system. Stored and loaded from non-\/volatile storage. 