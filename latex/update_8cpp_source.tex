\doxysection{update.\+cpp}
\hypertarget{update_8cpp_source}{}\label{update_8cpp_source}\index{include/update.cpp@{include/update.cpp}}
\mbox{\hyperlink{update_8cpp}{Go to the documentation of this file.}}
\begin{DoxyCode}{0}
\DoxyCodeLine{00001\ }
\DoxyCodeLine{00013\ \textcolor{preprocessor}{\#include\ <Arduino.h>}}
\DoxyCodeLine{00014\ \textcolor{preprocessor}{\#include\ <WiFi.h>}}
\DoxyCodeLine{00015\ \textcolor{preprocessor}{\#include\ <WiFiMulti.h>}}
\DoxyCodeLine{00016\ \textcolor{preprocessor}{\#include\ <HTTPClient.h>}}
\DoxyCodeLine{00017\ \textcolor{preprocessor}{\#include\ <HTTPUpdate.h>}}
\DoxyCodeLine{00018\ \textcolor{preprocessor}{\#include\ <tinyxml2.h>}}
\DoxyCodeLine{00019\ \textcolor{preprocessor}{\#include\ <MQTTMailer.hpp>}}
\DoxyCodeLine{00020\ }
\DoxyCodeLine{00021\ \textcolor{preprocessor}{\#include\ <MQTTMailer.hpp>}}
\DoxyCodeLine{00022\ }
\DoxyCodeLine{00023\ \textcolor{keyword}{using\ namespace\ }tinyxml2;}
\DoxyCodeLine{00024\ \textcolor{keyword}{using\ namespace\ }std;}
\DoxyCodeLine{00025\ }
\DoxyCodeLine{00030\ \textcolor{preprocessor}{\#define\ OTA\_SERVER\ "{}192.168.50.10"{}\ }}
\DoxyCodeLine{00031\ \textcolor{keyword}{extern}\ \textcolor{keyword}{const}\ \textcolor{keywordtype}{bool}\ \mbox{\hyperlink{update_8cpp_a45a3fd1220b5c8c7557fb18db8c20e50}{USB\_DEBUG}};\ \ \ \ \ \ \ \ }
\DoxyCodeLine{00032\ \textcolor{keyword}{extern}\ \mbox{\hyperlink{src_2main_8cpp_a2df27a00b191de3537c3b53adcecf1e8}{PubSubClient}}\ \mbox{\hyperlink{update_8cpp_a965861de1a367ef4c2b467de34de2683}{mqtt\_client}};\ \ \ \ }
\DoxyCodeLine{00033\ }
\DoxyCodeLine{00043\ \textcolor{keywordtype}{string}\ \mbox{\hyperlink{update_8cpp_a9b133af72f24d9221d811ae375854631}{new\_firmware\_version\_available}}()\ \{}
\DoxyCodeLine{00044\ }
\DoxyCodeLine{00045\ \ \ \ \ \textcolor{comment}{//Serial.println("{}\(\backslash\)tchecking\ available\ firmware\ version"{});}}
\DoxyCodeLine{00046\ \ \ \ \ \textcolor{keywordtype}{string}\ \mbox{\hyperlink{src_2main_8cpp_a2df27a00b191de3537c3b53adcecf1e8}{fw\_version\_url}}\ =\ \mbox{\hyperlink{src_2main_8cpp_a2df27a00b191de3537c3b53adcecf1e8}{string}}(\textcolor{stringliteral}{"{}http://"{}})\ +\ \mbox{\hyperlink{src_2main_8cpp_a2df27a00b191de3537c3b53adcecf1e8}{string}}(\mbox{\hyperlink{update_8cpp_adfcee2bc2c9061968f9738d7ddf0a396}{OTA\_SERVER}})\ +\ \mbox{\hyperlink{src_2main_8cpp_a2df27a00b191de3537c3b53adcecf1e8}{string}}(\textcolor{stringliteral}{"{}/current\_version.txt"{}});}
\DoxyCodeLine{00047\ \ \ \ \ \textcolor{keywordflow}{if}(\mbox{\hyperlink{update_8cpp_a45a3fd1220b5c8c7557fb18db8c20e50}{USB\_DEBUG}})\ \mbox{\hyperlink{src_2main_8cpp_a2df27a00b191de3537c3b53adcecf1e8}{Serial}}.printf(\textcolor{stringliteral}{"{}\(\backslash\)tchecking\ new\ fw\ version\ @\ \%s\(\backslash\)n"{}},\ \mbox{\hyperlink{src_2main_8cpp_a2df27a00b191de3537c3b53adcecf1e8}{fw\_version\_url}}.c\_str());}
\DoxyCodeLine{00048\ \ \ \ \ \ \ \ \ }
\DoxyCodeLine{00049\ \ \ \ \ \mbox{\hyperlink{src_2main_8cpp_a2df27a00b191de3537c3b53adcecf1e8}{HTTPClient}}\ \mbox{\hyperlink{src_2main_8cpp_a2df27a00b191de3537c3b53adcecf1e8}{httpClient}};}
\DoxyCodeLine{00050\ \ \ \ \ \mbox{\hyperlink{src_2main_8cpp_a2df27a00b191de3537c3b53adcecf1e8}{httpClient}}.begin(\ \mbox{\hyperlink{src_2main_8cpp_a2df27a00b191de3537c3b53adcecf1e8}{fw\_version\_url}}.c\_str()\ );}
\DoxyCodeLine{00051\ }
\DoxyCodeLine{00052\ \ \ \ \ \textcolor{keywordtype}{int}\ \mbox{\hyperlink{src_2main_8cpp_a2df27a00b191de3537c3b53adcecf1e8}{httpCode}}\ =\ \mbox{\hyperlink{src_2main_8cpp_a2df27a00b191de3537c3b53adcecf1e8}{httpClient}}.GET();}
\DoxyCodeLine{00053\ }
\DoxyCodeLine{00054\ \ \ \ \ \textcolor{keywordflow}{if}\ (\ \mbox{\hyperlink{src_2main_8cpp_a2df27a00b191de3537c3b53adcecf1e8}{httpCode}}\ ==\ 200\ )\ \{}
\DoxyCodeLine{00055\ \ \ \ \ \ \ \ \ \textcolor{keywordtype}{string}\ \mbox{\hyperlink{src_2main_8cpp_a2df27a00b191de3537c3b53adcecf1e8}{fw\_filename}}\ =\ \mbox{\hyperlink{src_2main_8cpp_a2df27a00b191de3537c3b53adcecf1e8}{httpClient}}.getString().c\_str();}
\DoxyCodeLine{00056\ \ \ \ \ \ \ \ \ \textcolor{keywordtype}{string}\ \mbox{\hyperlink{src_2main_8cpp_a2df27a00b191de3537c3b53adcecf1e8}{fw\_version}}\ =\ \mbox{\hyperlink{src_2main_8cpp_a2df27a00b191de3537c3b53adcecf1e8}{fw\_filename}}.substr(\mbox{\hyperlink{src_2main_8cpp_a2df27a00b191de3537c3b53adcecf1e8}{fw\_filename}}.length()-\/10,\ 6).c\_str();}
\DoxyCodeLine{00057\ }
\DoxyCodeLine{00058\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}(\mbox{\hyperlink{src_2main_8cpp_a2df27a00b191de3537c3b53adcecf1e8}{fw\_filename}}.length()\ <\ 10)\ \textcolor{keywordflow}{return}\ \textcolor{stringliteral}{"{}failure"{}};}
\DoxyCodeLine{00059\ }
\DoxyCodeLine{00060\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}(\mbox{\hyperlink{update_8cpp_a45a3fd1220b5c8c7557fb18db8c20e50}{USB\_DEBUG}})\{}
\DoxyCodeLine{00061\ \ \ \ \ \ \ \ \ \ \ \ \ \mbox{\hyperlink{src_2main_8cpp_a2df27a00b191de3537c3b53adcecf1e8}{Serial}}.print(\textcolor{stringliteral}{"{}\(\backslash\)tgot\ version\ string:\ \(\backslash\)"{}"{}});}
\DoxyCodeLine{00062\ \ \ \ \ \ \ \ \ \ \ \ \ \mbox{\hyperlink{src_2main_8cpp_a2df27a00b191de3537c3b53adcecf1e8}{Serial}}.print(\mbox{\hyperlink{src_2main_8cpp_a2df27a00b191de3537c3b53adcecf1e8}{fw\_version}}.c\_str());}
\DoxyCodeLine{00063\ \ \ \ \ \ \ \ \ \ \ \ \ \mbox{\hyperlink{src_2main_8cpp_a2df27a00b191de3537c3b53adcecf1e8}{Serial}}.println(\textcolor{stringliteral}{"{}\(\backslash\)"{}"{}});}
\DoxyCodeLine{00064\ \ \ \ \ \ \ \ \ \ \ \ \ \mbox{\hyperlink{src_2main_8cpp_a2df27a00b191de3537c3b53adcecf1e8}{Serial}}.printf(\textcolor{stringliteral}{"{}\(\backslash\)tfrom:\ \(\backslash\)'\%s\(\backslash\)'\(\backslash\)n"{}},\ \mbox{\hyperlink{src_2main_8cpp_a2df27a00b191de3537c3b53adcecf1e8}{fw\_filename}}.c\_str());}
\DoxyCodeLine{00065\ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{00066\ }
\DoxyCodeLine{00067\ \ \ \ \ \ \ \ \ \textcolor{keywordtype}{int}\ \mbox{\hyperlink{src_2main_8cpp_a2df27a00b191de3537c3b53adcecf1e8}{version\_major}}\ =\ \mbox{\hyperlink{src_2main_8cpp_a2df27a00b191de3537c3b53adcecf1e8}{stoi}}(\mbox{\hyperlink{src_2main_8cpp_a2df27a00b191de3537c3b53adcecf1e8}{fw\_filename}}.substr(\mbox{\hyperlink{src_2main_8cpp_a2df27a00b191de3537c3b53adcecf1e8}{fw\_filename}}.length()-\/9,\ 1));}
\DoxyCodeLine{00068\ \ \ \ \ \ \ \ \ \textcolor{keywordtype}{int}\ \mbox{\hyperlink{src_2main_8cpp_a2df27a00b191de3537c3b53adcecf1e8}{version\_minor}}\ =\ \mbox{\hyperlink{src_2main_8cpp_a2df27a00b191de3537c3b53adcecf1e8}{stoi}}(\mbox{\hyperlink{src_2main_8cpp_a2df27a00b191de3537c3b53adcecf1e8}{fw\_filename}}.substr(\mbox{\hyperlink{src_2main_8cpp_a2df27a00b191de3537c3b53adcecf1e8}{fw\_filename}}.length()-\/7,\ 1));}
\DoxyCodeLine{00069\ \ \ \ \ \ \ \ \ \textcolor{keywordtype}{int}\ \mbox{\hyperlink{src_2main_8cpp_a2df27a00b191de3537c3b53adcecf1e8}{version\_patch}}\ =\ \mbox{\hyperlink{src_2main_8cpp_a2df27a00b191de3537c3b53adcecf1e8}{stoi}}(\mbox{\hyperlink{src_2main_8cpp_a2df27a00b191de3537c3b53adcecf1e8}{fw\_filename}}.substr(\mbox{\hyperlink{src_2main_8cpp_a2df27a00b191de3537c3b53adcecf1e8}{fw\_filename}}.length()-\/5,\ 1));}
\DoxyCodeLine{00070\ }
\DoxyCodeLine{00071\ \ \ \ \ \ \ \ \ \mbox{\hyperlink{classMQTTMailer}{MQTTMailer}}\ \mbox{\hyperlink{src_2main_8cpp_a2df27a00b191de3537c3b53adcecf1e8}{instance}}\ =\ MQTTMailer::getInstance();}
\DoxyCodeLine{00072\ \ \ \ \ \ \ \ \ std::string\ topic\ =\ \textcolor{stringliteral}{"{}datagator/ota\_status/"{}}\ +\ std::string(\mbox{\hyperlink{src_2main_8cpp_a2df27a00b191de3537c3b53adcecf1e8}{WiFi}}.macAddress().c\_str());}
\DoxyCodeLine{00073\ \ \ \ \ \ \ \ \ std::string\ \mbox{\hyperlink{src_2main_8cpp_a2df27a00b191de3537c3b53adcecf1e8}{msg}}\ =\ \textcolor{stringliteral}{"{}\{\(\backslash\)"{}STATUS\_MSG\(\backslash\)"{}:\ \(\backslash\)"{}version\(\backslash\)"{},\ \(\backslash\)"{}SERVER\_FW\_VERSION\(\backslash\)"{}:\ \(\backslash\)"{}"{}}\ +\ \mbox{\hyperlink{src_2main_8cpp_a2df27a00b191de3537c3b53adcecf1e8}{fw\_version}}\ +\ }
\DoxyCodeLine{00074\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{stringliteral}{"{}\(\backslash\)"{},\ \(\backslash\)"{}DEVICE\_FW\_VERSION\(\backslash\)"{}:\ \(\backslash\)"{}v"{}}\ +\ to\_string(VERSION\_MAJOR)\ +\ }
\DoxyCodeLine{00075\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{stringliteral}{"{}."{}}\ +\ to\_string(VERSION\_MINOR)\ +\ }
\DoxyCodeLine{00076\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{stringliteral}{"{}."{}}\ +\ to\_string(VERSION\_PATCH)\ +\ }
\DoxyCodeLine{00077\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{stringliteral}{"{}\(\backslash\)"{}\}"{}};}
\DoxyCodeLine{00078\ \ \ \ \ \ \ \ \ \mbox{\hyperlink{src_2main_8cpp_a2df27a00b191de3537c3b53adcecf1e8}{instance}}.mailMessage(\&\mbox{\hyperlink{update_8cpp_a965861de1a367ef4c2b467de34de2683}{mqtt\_client}},\ topic,\ \mbox{\hyperlink{src_2main_8cpp_a2df27a00b191de3537c3b53adcecf1e8}{msg}});}
\DoxyCodeLine{00079\ \ \ \ \ }
\DoxyCodeLine{00080\ }
\DoxyCodeLine{00081\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}(\mbox{\hyperlink{update_8cpp_a45a3fd1220b5c8c7557fb18db8c20e50}{USB\_DEBUG}})\ \mbox{\hyperlink{src_2main_8cpp_a2df27a00b191de3537c3b53adcecf1e8}{Serial}}.printf(\textcolor{stringliteral}{"{}\(\backslash\)tv\_maj:\ \%d,\ v\_min:\ \%d,\ v\_patch:\ \%d\(\backslash\)n"{}},\ \mbox{\hyperlink{src_2main_8cpp_a2df27a00b191de3537c3b53adcecf1e8}{version\_major}},\ \mbox{\hyperlink{src_2main_8cpp_a2df27a00b191de3537c3b53adcecf1e8}{version\_minor}},\ \mbox{\hyperlink{src_2main_8cpp_a2df27a00b191de3537c3b53adcecf1e8}{version\_patch}});}
\DoxyCodeLine{00082\ }
\DoxyCodeLine{00083\ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ if\ version\ doesn't\ match,\ update}}
\DoxyCodeLine{00084\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}(\mbox{\hyperlink{src_2main_8cpp_a2df27a00b191de3537c3b53adcecf1e8}{version\_minor}}\ !=\ VERSION\_MINOR\ ||\ \mbox{\hyperlink{src_2main_8cpp_a2df27a00b191de3537c3b53adcecf1e8}{version\_major}}\ !=\ VERSION\_MAJOR\ ||\ \mbox{\hyperlink{src_2main_8cpp_a2df27a00b191de3537c3b53adcecf1e8}{version\_patch}}\ !=\ VERSION\_PATCH)\{}
\DoxyCodeLine{00085\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{return}\ \mbox{\hyperlink{src_2main_8cpp_a2df27a00b191de3537c3b53adcecf1e8}{fw\_filename}};}
\DoxyCodeLine{00086\ \ \ \ \ \ \ \ \ \}\textcolor{keywordflow}{else}\{}
\DoxyCodeLine{00087\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{return}\ \textcolor{stringliteral}{"{}"{}};}
\DoxyCodeLine{00088\ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{00089\ }
\DoxyCodeLine{00090\ }
\DoxyCodeLine{00091\ \ \ \ \ \}\textcolor{keywordflow}{else}\{}
\DoxyCodeLine{00092\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}(\mbox{\hyperlink{update_8cpp_a45a3fd1220b5c8c7557fb18db8c20e50}{USB\_DEBUG}})\{}
\DoxyCodeLine{00093\ \ \ \ \ \ \ \ \ \ \ \ \ \mbox{\hyperlink{src_2main_8cpp_a2df27a00b191de3537c3b53adcecf1e8}{Serial}}.print(\textcolor{stringliteral}{"{}\(\backslash\)thttp\ connection\ failed\ with\ code\ "{}});}
\DoxyCodeLine{00094\ \ \ \ \ \ \ \ \ \ \ \ \ \mbox{\hyperlink{src_2main_8cpp_a2df27a00b191de3537c3b53adcecf1e8}{Serial}}.print(\mbox{\hyperlink{src_2main_8cpp_a2df27a00b191de3537c3b53adcecf1e8}{httpCode}});}
\DoxyCodeLine{00095\ \ \ \ \ \ \ \ \ \ \ \ \ \mbox{\hyperlink{src_2main_8cpp_a2df27a00b191de3537c3b53adcecf1e8}{Serial}}.print(\textcolor{stringliteral}{"{}:\ "{}});}
\DoxyCodeLine{00096\ \ \ \ \ \ \ \ \ \ \ \ \ \mbox{\hyperlink{src_2main_8cpp_a2df27a00b191de3537c3b53adcecf1e8}{Serial}}.println(\mbox{\hyperlink{src_2main_8cpp_a2df27a00b191de3537c3b53adcecf1e8}{httpClient}}.errorToString(\mbox{\hyperlink{src_2main_8cpp_a2df27a00b191de3537c3b53adcecf1e8}{httpCode}}));}
\DoxyCodeLine{00097\ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{00098\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{return}\ \textcolor{stringliteral}{"{}"{}};}
\DoxyCodeLine{00099\ \ \ \ \ \}}
\DoxyCodeLine{00100\ \}}
\DoxyCodeLine{00101\ }
\DoxyCodeLine{00111\ \textcolor{keywordtype}{void}\ \mbox{\hyperlink{update_8cpp_a59d61902e825ebabe0a2259ba8e906ac}{update\_progress}}(\textcolor{keywordtype}{int}\ \mbox{\hyperlink{src_2main_8cpp_a2df27a00b191de3537c3b53adcecf1e8}{cur}},\ \textcolor{keywordtype}{int}\ \mbox{\hyperlink{src_2main_8cpp_a2df27a00b191de3537c3b53adcecf1e8}{total}})\{}
\DoxyCodeLine{00112\ \ \ \ \ \textcolor{keywordflow}{if}(\mbox{\hyperlink{update_8cpp_a45a3fd1220b5c8c7557fb18db8c20e50}{USB\_DEBUG}})\ \mbox{\hyperlink{src_2main_8cpp_a2df27a00b191de3537c3b53adcecf1e8}{Serial}}.printf(\textcolor{stringliteral}{"{}CALLBACK:\ \ HTTP\ update\ process\ at\ \%d\ of\ \%d\ bytes...\(\backslash\)n"{}},\ \mbox{\hyperlink{src_2main_8cpp_a2df27a00b191de3537c3b53adcecf1e8}{cur}},\ \mbox{\hyperlink{src_2main_8cpp_a2df27a00b191de3537c3b53adcecf1e8}{total}});}
\DoxyCodeLine{00113\ \}}
\DoxyCodeLine{00114\ }
\DoxyCodeLine{00121\ \textcolor{keywordtype}{void}\ \mbox{\hyperlink{update_8cpp_ac30dfa0188e237f4ae0f983a8dd84888}{update\_started}}()\{}
\DoxyCodeLine{00122\ \ \ \ \ \textcolor{keywordflow}{if}(\mbox{\hyperlink{update_8cpp_a45a3fd1220b5c8c7557fb18db8c20e50}{USB\_DEBUG}})\ \mbox{\hyperlink{src_2main_8cpp_a2df27a00b191de3537c3b53adcecf1e8}{Serial}}.println(\textcolor{stringliteral}{"{}CALLBACK:\ HTTP\ update\ process\ started"{}});}
\DoxyCodeLine{00123\ \ \ \ \ \mbox{\hyperlink{classMQTTMailer}{MQTTMailer}}\ \mbox{\hyperlink{src_2main_8cpp_a2df27a00b191de3537c3b53adcecf1e8}{instance}}\ =\ MQTTMailer::getInstance();}
\DoxyCodeLine{00124\ \ \ \ \ std::string\ topic\ =\ \textcolor{stringliteral}{"{}datagator/ota\_status/"{}}\ +\ std::string(\mbox{\hyperlink{src_2main_8cpp_a2df27a00b191de3537c3b53adcecf1e8}{WiFi}}.macAddress().c\_str());}
\DoxyCodeLine{00125\ \ \ \ \ std::string\ \mbox{\hyperlink{src_2main_8cpp_a2df27a00b191de3537c3b53adcecf1e8}{msg}}\ =\ \textcolor{stringliteral}{"{}\{\(\backslash\)"{}STATUS\_MSG\(\backslash\)"{}:\ \(\backslash\)"{}started\(\backslash\)"{}\}"{}};}
\DoxyCodeLine{00126\ \ \ \ \ \mbox{\hyperlink{src_2main_8cpp_a2df27a00b191de3537c3b53adcecf1e8}{instance}}.mailMessage(\&\mbox{\hyperlink{update_8cpp_a965861de1a367ef4c2b467de34de2683}{mqtt\_client}},\ topic,\ \mbox{\hyperlink{src_2main_8cpp_a2df27a00b191de3537c3b53adcecf1e8}{msg}});}
\DoxyCodeLine{00127\ }
\DoxyCodeLine{00128\ \}}
\DoxyCodeLine{00129\ }
\DoxyCodeLine{00136\ \textcolor{keywordtype}{void}\ \mbox{\hyperlink{update_8cpp_a4ab67b93fc9ac13fed541d66e044a039}{update\_finished}}()\{}
\DoxyCodeLine{00137\ \ \ \ \ \textcolor{keywordflow}{if}(\mbox{\hyperlink{update_8cpp_a45a3fd1220b5c8c7557fb18db8c20e50}{USB\_DEBUG}})\ \mbox{\hyperlink{src_2main_8cpp_a2df27a00b191de3537c3b53adcecf1e8}{Serial}}.println(\textcolor{stringliteral}{"{}update\ finished"{}});}
\DoxyCodeLine{00138\ \ \ \ \ \mbox{\hyperlink{classMQTTMailer}{MQTTMailer}}\ \mbox{\hyperlink{src_2main_8cpp_a2df27a00b191de3537c3b53adcecf1e8}{instance}}\ =\ MQTTMailer::getInstance();}
\DoxyCodeLine{00139\ \ \ \ \ std::string\ topic\ =\ \textcolor{stringliteral}{"{}datagator/ota\_status/"{}}\ +\ std::string(\mbox{\hyperlink{src_2main_8cpp_a2df27a00b191de3537c3b53adcecf1e8}{WiFi}}.macAddress().c\_str());}
\DoxyCodeLine{00140\ \ \ \ \ std::string\ \mbox{\hyperlink{src_2main_8cpp_a2df27a00b191de3537c3b53adcecf1e8}{msg}}\ =\ \textcolor{stringliteral}{"{}\{\(\backslash\)"{}STATUS\_MSG\(\backslash\)"{}:\ \(\backslash\)"{}finished\(\backslash\)"{}\}"{}};}
\DoxyCodeLine{00141\ \ \ \ \ \mbox{\hyperlink{src_2main_8cpp_a2df27a00b191de3537c3b53adcecf1e8}{instance}}.mailMessage(\&\mbox{\hyperlink{update_8cpp_a965861de1a367ef4c2b467de34de2683}{mqtt\_client}},\ topic,\ \mbox{\hyperlink{src_2main_8cpp_a2df27a00b191de3537c3b53adcecf1e8}{msg}});}
\DoxyCodeLine{00142\ }
\DoxyCodeLine{00143\ \}}
\DoxyCodeLine{00144\ }
\DoxyCodeLine{00145\ }
\DoxyCodeLine{00153\ \textcolor{keywordtype}{void}\ \mbox{\hyperlink{update_8cpp_a91745750976b456ed74139d5c6a07473}{update\_error}}(\textcolor{keywordtype}{int}\ \mbox{\hyperlink{src_2main_8cpp_a2df27a00b191de3537c3b53adcecf1e8}{err}})\ \{}
\DoxyCodeLine{00154\ \ \ \ \ \textcolor{keywordflow}{if}(\mbox{\hyperlink{update_8cpp_a45a3fd1220b5c8c7557fb18db8c20e50}{USB\_DEBUG}})\ \mbox{\hyperlink{src_2main_8cpp_a2df27a00b191de3537c3b53adcecf1e8}{Serial}}.printf(\textcolor{stringliteral}{"{}CALLBACK:\ \ HTTP\ update\ fatal\ error\ code\ \%d\(\backslash\)n"{}},\ \mbox{\hyperlink{src_2main_8cpp_a2df27a00b191de3537c3b53adcecf1e8}{err}});}
\DoxyCodeLine{00155\ \ \ \ \ \mbox{\hyperlink{classMQTTMailer}{MQTTMailer}}\ \mbox{\hyperlink{src_2main_8cpp_a2df27a00b191de3537c3b53adcecf1e8}{instance}}\ =\ MQTTMailer::getInstance();}
\DoxyCodeLine{00156\ \ \ \ \ std::string\ topic\ =\ \textcolor{stringliteral}{"{}datagator/ota/"{}}\ +\ std::string(\mbox{\hyperlink{src_2main_8cpp_a2df27a00b191de3537c3b53adcecf1e8}{WiFi}}.macAddress().c\_str());}
\DoxyCodeLine{00157\ \ \ \ \ std::string\ \mbox{\hyperlink{src_2main_8cpp_a2df27a00b191de3537c3b53adcecf1e8}{msg}}\ =\ \textcolor{stringliteral}{"{}\{\(\backslash\)"{}STATUS\_MSG\(\backslash\)"{}:\ \(\backslash\)"{}error\(\backslash\)"{}\}"{}};}
\DoxyCodeLine{00158\ \ \ \ \ \mbox{\hyperlink{src_2main_8cpp_a2df27a00b191de3537c3b53adcecf1e8}{instance}}.mailMessage(\&\mbox{\hyperlink{update_8cpp_a965861de1a367ef4c2b467de34de2683}{mqtt\_client}},\ topic,\ \mbox{\hyperlink{src_2main_8cpp_a2df27a00b191de3537c3b53adcecf1e8}{msg}});}
\DoxyCodeLine{00159\ \}}
\DoxyCodeLine{00160\ }
\DoxyCodeLine{00178\ \textcolor{keywordtype}{void}\ \mbox{\hyperlink{update_8cpp_ac73e1e13b3305f391b3319037813e9b0}{attempt\_update}}()\ \{}
\DoxyCodeLine{00179\ \ \ \ \ std::string\ \mbox{\hyperlink{src_2main_8cpp_a2df27a00b191de3537c3b53adcecf1e8}{file\_name}}\ =\ \mbox{\hyperlink{update_8cpp_a9b133af72f24d9221d811ae375854631}{new\_firmware\_version\_available}}();}
\DoxyCodeLine{00180\ }
\DoxyCodeLine{00181\ \ \ \ \ \textcolor{keywordflow}{if}(\mbox{\hyperlink{src_2main_8cpp_a2df27a00b191de3537c3b53adcecf1e8}{file\_name}}\ !=\ \textcolor{stringliteral}{"{}"{}})\{}
\DoxyCodeLine{00182\ }
\DoxyCodeLine{00183\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{for}(\textcolor{keywordtype}{int}\ i\ =\ 0;\ i\ <\ 3;\ i++)\{}
\DoxyCodeLine{00184\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ wait\ for\ WiFi\ connection}}
\DoxyCodeLine{00185\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}(\mbox{\hyperlink{update_8cpp_a45a3fd1220b5c8c7557fb18db8c20e50}{USB\_DEBUG}})\ \mbox{\hyperlink{src_2main_8cpp_a2df27a00b191de3537c3b53adcecf1e8}{Serial}}.println(\textcolor{stringliteral}{"{}starting\ update\ attempt"{}});}
\DoxyCodeLine{00186\ }
\DoxyCodeLine{00187\ \ \ \ \ \ \ \ \ \ \ \ \ \mbox{\hyperlink{src_2main_8cpp_a2df27a00b191de3537c3b53adcecf1e8}{WiFiClient}}\ \mbox{\hyperlink{src_2main_8cpp_a2df27a00b191de3537c3b53adcecf1e8}{client}};}
\DoxyCodeLine{00188\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}(\mbox{\hyperlink{update_8cpp_a45a3fd1220b5c8c7557fb18db8c20e50}{USB\_DEBUG}})\ \mbox{\hyperlink{src_2main_8cpp_a2df27a00b191de3537c3b53adcecf1e8}{Serial}}.println(\textcolor{stringliteral}{"{}client\ created"{}});}
\DoxyCodeLine{00189\ \ \ \ \ \ \ \ \ \ \ \ \ \mbox{\hyperlink{src_2main_8cpp_a2df27a00b191de3537c3b53adcecf1e8}{httpUpdate}}.onStart(\mbox{\hyperlink{update_8cpp_ac30dfa0188e237f4ae0f983a8dd84888}{update\_started}});}
\DoxyCodeLine{00190\ \ \ \ \ \ \ \ \ \ \ \ \ \mbox{\hyperlink{src_2main_8cpp_a2df27a00b191de3537c3b53adcecf1e8}{httpUpdate}}.onEnd(\mbox{\hyperlink{update_8cpp_a4ab67b93fc9ac13fed541d66e044a039}{update\_finished}});}
\DoxyCodeLine{00191\ \ \ \ \ \ \ \ \ \ \ \ \ \mbox{\hyperlink{src_2main_8cpp_a2df27a00b191de3537c3b53adcecf1e8}{httpUpdate}}.onProgress(\mbox{\hyperlink{update_8cpp_a59d61902e825ebabe0a2259ba8e906ac}{update\_progress}});}
\DoxyCodeLine{00192\ \ \ \ \ \ \ \ \ \ \ \ \ \mbox{\hyperlink{src_2main_8cpp_a2df27a00b191de3537c3b53adcecf1e8}{httpUpdate}}.onError(\mbox{\hyperlink{update_8cpp_a91745750976b456ed74139d5c6a07473}{update\_error}});}
\DoxyCodeLine{00193\ }
\DoxyCodeLine{00194\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordtype}{string}\ \mbox{\hyperlink{src_2main_8cpp_a2df27a00b191de3537c3b53adcecf1e8}{fw\_url}}\ =\ \mbox{\hyperlink{src_2main_8cpp_a2df27a00b191de3537c3b53adcecf1e8}{string}}(\textcolor{stringliteral}{"{}http://"{}})\ +\ \mbox{\hyperlink{src_2main_8cpp_a2df27a00b191de3537c3b53adcecf1e8}{string}}(\mbox{\hyperlink{update_8cpp_adfcee2bc2c9061968f9738d7ddf0a396}{OTA\_SERVER}})\ +\ \mbox{\hyperlink{src_2main_8cpp_a2df27a00b191de3537c3b53adcecf1e8}{string}}(\textcolor{stringliteral}{"{}/"{}})\ +\ \mbox{\hyperlink{src_2main_8cpp_a2df27a00b191de3537c3b53adcecf1e8}{file\_name}};}
\DoxyCodeLine{00195\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}(\mbox{\hyperlink{update_8cpp_a45a3fd1220b5c8c7557fb18db8c20e50}{USB\_DEBUG}})\ \mbox{\hyperlink{src_2main_8cpp_a2df27a00b191de3537c3b53adcecf1e8}{Serial}}.println(\mbox{\hyperlink{src_2main_8cpp_a2df27a00b191de3537c3b53adcecf1e8}{fw\_url}}.c\_str());}
\DoxyCodeLine{00196\ }
\DoxyCodeLine{00197\ \ \ \ \ \ \ \ \ \ \ \ \ \mbox{\hyperlink{src_2main_8cpp_a2df27a00b191de3537c3b53adcecf1e8}{t\_httpUpdate\_return}}\ \mbox{\hyperlink{src_2main_8cpp_a2df27a00b191de3537c3b53adcecf1e8}{ret}}\ =\ \mbox{\hyperlink{src_2main_8cpp_a2df27a00b191de3537c3b53adcecf1e8}{httpUpdate}}.update(\mbox{\hyperlink{src_2main_8cpp_a2df27a00b191de3537c3b53adcecf1e8}{client}},\ \mbox{\hyperlink{src_2main_8cpp_a2df27a00b191de3537c3b53adcecf1e8}{fw\_url}}.c\_str());}
\DoxyCodeLine{00198\ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{00199\ \ \ \ \ \}}
\DoxyCodeLine{00200\ \}}

\end{DoxyCode}
